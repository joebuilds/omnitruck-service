---
FASTLY_API_KEY:
  path: secret/fastly/data/omnitruck-service
  field: token
AWS_ACCESS_KEY_ID:
  account: aws/chef-telemetry
  field: token

steps:
  - label: ':terraform: init & plan'
    agents:
      queue: default-privileged
    command: |
      cd terraform/cdn

      which tfenv || echo ""
      which terraform || echo ""

      sudo ls -lR /home/ec2-user/.tfenv/bin
      sudo ls -lR /home/ec2-user

      terraform version
      tfenv version

      terraform init -migrate-state -force-copy -input=false
      terraform plan -out="$(terraform workspace show).tfplan" -input=false

  - block: ":rocket: Release!"

  - label: ':terraform: apply'
    agents:
      queue: default-privileged
    command: |
      cd terraform/cdn
      # debug
      echo terraform apply "$(terraform workspace show).tfplan" -input=false
      ls -lR
